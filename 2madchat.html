<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Multi-Chat (Firefox Compatible)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0e0e10; color: white; margin: 0; height: 100vh; overflow: hidden; }
        #setup { padding: 40px; max-width: 450px; margin: 50px auto; background: #1f1f23; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #adadb8; font-weight: bold; }
        select, input { width: 100%; padding: 12px; background: #3a3a3d; border: 2px solid #464649; color: white; border-radius: 6px; box-sizing: border-box; transition: border-color 0.2s; }
        select:focus, input:focus { border-color: #9147ff; outline: none; }
        button { width: 100%; padding: 14px; background: #9147ff; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 1rem; }
        button:hover { background: #772ce8; }
        
        #chat-grid { display: grid; gap: 4px; width: 100vw; height: 100vh; background: #000; }
        .chat-wrapper { position: relative; width: 100%; height: 100%; background: #18181b; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* エラー回避用のヒントメッセージ */
        .fallback-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #adadb8; z-index: -1; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="setup">
    <h2 style="margin-top:0; color:#bf94ff;">Chat Aggregator</h2>
    
    <div class="input-group">
        <label>1. レイアウト</label>
        <select id="layout">
            <option value="v">縦長 (並列)</option>
            <option value="h">横長 (上下)</option>
            <option value="g">クロス (グリッド)</option>
        </select>
    </div>

    <div class="input-group">
        <label>2. チャンネル数</label>
        <input type="number" id="count" min="1" max="12" value="2">
    </div>

    <button id="step-next">次へ進む</button>

    <div id="id-input-area" class="hidden" style="margin-top: 25px; border-top: 1px solid #464649; padding-top: 20px;">
        <label>3. チャンネルIDを入力</label>
        <div id="id-fields"></div>
        <button id="start-btn" style="margin-top: 15px;">チャットを開始</button>
    </div>
</div>

<div id="chat-grid" class="hidden"></div>

<script>
    const setup = document.getElementById('setup');
    const idFields = document.getElementById('id-fields');
    const chatGrid = document.getElementById('chat-grid');

    document.getElementById('step-next').addEventListener('click', () => {
        const count = document.getElementById('count').value;
        idFields.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const input = document.createElement('input');
            input.placeholder = `ch-${i+1} (例: stylishnoob4)`;
            input.className = 'ch-input';
            input.style.marginBottom = '8px';
            idFields.appendChild(input);
        }
        document.getElementById('id-input-area').classList.remove('hidden');
    });

    document.getElementById('start-btn').addEventListener('click', () => {
        const ids = Array.from(document.querySelectorAll('.ch-input'))
                         .map(el => el.value.trim())
                         .filter(id => id !== '');
        
        if (ids.length === 0) return alert('IDを入力してください');

        const layout = document.getElementById('layout').value;
        
        // レイアウト適用
        if (layout === 'v') {
            chatGrid.style.gridTemplateColumns = `repeat(${ids.length}, 1fr)`;
        } else if (layout === 'h') {
            chatGrid.style.gridTemplateRows = `repeat(${ids.length}, 1fr)`;
        } else {
            const cols = Math.ceil(Math.sqrt(ids.length));
            chatGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        }

        ids.forEach(id => {
            const wrapper = document.createElement('div');
            wrapper.className = 'chat-wrapper';
            
            // Firefoxでも読み込みやすいpopout形式を使用
            // parentに現在の場所を指定（file:///対策として複数を指定）
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.twitch.tv/embed/${id}/chat?parent=localhost&parent=127.0.0.1&darkpopout`;
            
            // 万が一表示されない時用のメッセージ
            wrapper.innerHTML = `<div class="fallback-msg">
                <p>読み込み中...<br><small>表示されない場合は、この枠内をクリックしてログインするか、<br>シークレットモードを解除してください。</small></p>
            </div>`;
            
            wrapper.appendChild(iframe);
            chatGrid.appendChild(wrapper);
        });

        setup.classList.add('hidden');
        chatGrid.classList.remove('hidden');
    });
</script>

</body>
</html>