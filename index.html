<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Stream Review Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #player-container { flex: 2; background: #000; position: relative; border-bottom: 2px solid #9146ff; }
        #player { width: 100%; height: 100%; }
        #graph-container { flex: 1; background: #18181b; padding: 10px; }
        .info-bar { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px; font-size: 14px; border: 1px solid #9146ff; }
        #status-dot { height: 10px; width: 10px; background-color: #f00; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="player-container">
    <div id="player"></div>
    <div class="info-bar">
        <span id="status-dot"></span>
        <span id="display-text">チャット受信待機中（!end でアーカイブ読込）</span>
    </div>
</div>

<div id="graph-container">
    <canvas id="chatChart"></canvas>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    let startTime = Date.now();
    let chatTimestamps = [];
    let player = null;
    let chart = null;

    if (!channel) {
        alert("URLの末尾に ?channel=あなたのID を付けてアクセスしてください");
    } else {
        ComfyJS.Init(channel);
    }

    // チャット受信
    ComfyJS.onChat = (user, message, flags, self, extra) => {
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        chatTimestamps.push(elapsedSeconds);
        updateChart();
    };

    // コマンド受信
    ComfyJS.onCommand = (user, command, message, flags, extra) => {
        if (command === "end" && (flags.broadcaster || flags.mod)) {
            fetchVODAndLoad();
        }
    };

    async function fetchVODAndLoad() {
        document.getElementById('display-text').innerText = "最新アーカイブを検索中...";
        try {
            const response = await fetch(`https://decapi.me/twitch/videos/${channel}?limit=1&type=archive`);
            const rawData = await response.text();
            
            // ID以外の文字（タイトルなど）が混ざる場合を考慮してID（数字）のみ抽出
            const vodMatch = rawData.match(/\d+/);
            const vodId = vodMatch ? vodMatch[0] : null;

            if (vodId) {
                loadVOD(vodId);
                document.getElementById('display-text').innerText = `アーカイブ ${vodId} を読込完了。グラフをクリックしてシーク可能`;
                document.getElementById('status-dot').style.backgroundColor = "#9146ff";
            } else {
                document.getElementById('display-text').innerText = "VODが見つかりません。";
            }
        } catch (error) {
            document.getElementById('display-text').innerText = "APIエラーが発生しました。";
        }
    }

    function loadVOD(vodId) {
        document.getElementById('player').innerHTML = "";
        
        // GitHub Pages のドメインを parent に指定
        const host = window.location.hostname;
        
        player = new Twitch.Player("player", {
            width: "100%",
            height: "100%",
            video: vodId,
            autoplay: true,
            parent: [host] // これでセキュリティエラーが解消されます
        });
    }

    // グラフ描画
    const ctx = document.getElementById('chatChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'チャット数 / 分',
                data: [],
                borderColor: '#9146ff',
                backgroundColor: 'rgba(145, 70, 255, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#333' } },
                x: { title: { display: true, text: '配信経過時間 (分)', color: '#9146ff' }, grid: { color: '#333' } }
            },
            onClick: (event, elements) => {
                if (elements.length > 0 && player) {
                    const index = elements[0].index;
                    const targetMinute = chart.data.labels[index];
                    player.seek(targetMinute * 60);
                }
            }
        }
    });

    function updateChart() {
        const bins = {};
        let maxMin = 0;
        chatTimestamps.forEach(sec => {
            const min = Math.floor(sec / 60);
            bins[min] = (bins[min] || 0) + 1;
            if (min > maxMin) maxMin = min;
        });
        const labels = [];
        const data = [];
        for (let i = 0; i <= maxMin; i++) {
            labels.push(i);
            data.push(bins[i] || 0);
        }
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update('none');
    }
</script>
</body>
</html>