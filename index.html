<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Stream Reviewer</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #0e0e10; color: #efeff1; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 上部プレイヤーエリア */
        #player-container { flex: 2; background: #000; position: relative; border-bottom: 2px solid #9146ff; display: flex; justify-content: center; align-items: center; }
        #player { width: 100%; height: 100%; }

        /* 情報バー */
        .info-bar { position: absolute; top: 15px; left: 15px; z-index: 100; background: rgba(24, 24, 27, 0.85); padding: 10px 20px; border-radius: 30px; font-size: 14px; border: 1px solid #9146ff; box-shadow: 0 4px 15px rgba(0,0,0,0.5); pointer-events: none; }
        #status-dot { height: 10px; width: 10px; background-color: #eb0400; border-radius: 50%; display: inline-block; margin-right: 8px; animation: blink 1.2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* 下部グラフエリア */
        #graph-container { flex: 1; background: #18181b; padding: 15px; box-sizing: border-box; }
        canvas { width: 100% !important; height: 100% !important; }

        /* ローディング・エラー表示 */
        #placeholder-text { color: #adadb8; font-size: 18px; text-align: center; }
    </style>
</head>
<body>

<div id="player-container">
    <div id="player">
        <div id="placeholder-text">配信中にチャットで <strong>!end</strong> と打つと<br>ここにアーカイブが読み込まれます</div>
    </div>
    <div class="info-bar">
        <span id="status-dot"></span>
        <span id="display-text">接続待機中...</span>
    </div>
</div>

<div id="graph-container">
    <canvas id="chatChart"></canvas>
</div>

<script>
    /* --- 初期設定 --- */
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    const startTime = Date.now();
    let chatTimestamps = [];
    let player = null;
    let chart = null;

    if (!channel) {
        document.body.innerHTML = "<h2 style='padding:20px;'>エラー: URLの末尾に ?channel=自分のID を追加してください</h2>";
    } else {
        ComfyJS.Init(channel);
        document.getElementById('display-text').innerText = `チャンネル: ${channel} のチャットを監視中...`;
    }

    /* --- チャット受信処理 --- */
    ComfyJS.onChat = (user, message, flags, self, extra) => {
        // ページを開いてからの経過秒数を記録
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        chatTimestamps.push(elapsedSeconds);
        updateChart();
    };

    /* --- !end コマンドでアーカイブ取得 --- */
    ComfyJS.onCommand = (user, command, message, flags, extra) => {
        if (command === "end" && (flags.broadcaster || flags.mod)) {
            fetchVODAndLoad();
        }
    };

    async function fetchVODAndLoad() {
        const displayText = document.getElementById('display-text');
        displayText.innerText = "最新アーカイブを検索中...";
        
        try {
            // DecAPIを使用して最新のアーカイブ情報を取得
            const response = await fetch(`https://decapi.me/twitch/videos/${channel}?limit=1&type=archive`);
            const rawData = await response.text();
            
            // 取得したテキストから数字（VOD ID）だけを抽出
            const vodMatch = rawData.match(/\d+/);
            const vodId = vodMatch ? vodMatch[0] : null;

            if (vodId) {
                console.log("Found VOD ID:", vodId);
                loadTwitchPlayer(vodId);
                displayText.innerText = `VOD ID: ${vodId} を読み込みました。グラフをクリックして移動できます。`;
                document.getElementById('status-dot').style.backgroundColor = "#9146ff";
            } else {
                displayText.innerText = "アーカイブが見つかりませんでした。VOD保存設定を確認してください。";
            }
        } catch (error) {
            console.error(error);
            displayText.innerText = "API取得エラーが発生しました。";
        }
    }

    /* --- Twitchプレイヤー埋め込み --- */
    function loadTwitchPlayer(vodId) {
        document.getElementById('player').innerHTML = ""; // プレースホルダーを消去
        
        // GitHub Pagesのドメイン(username.github.io)を自動取得
        const host = window.location.hostname;

        player = new Twitch.Player("player", {
            width: "100%",
            height: "100%",
            video: vodId,
            autoplay: true,
            muted: false,
            parent: [host] // セキュリティエラー回避の重要設定
        });
    }

    /* --- グラフ関連 (Chart.js) --- */
    const ctx = document.getElementById('chatChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], 
            datasets: [{
                label: 'チャット数 / 分',
                data: [],
                borderColor: '#9146ff',
                backgroundColor: 'rgba(145, 70, 255, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#9146ff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#26262c' }, ticks: { color: '#adadb8' } },
                x: { title: { display: true, text: '配信開始からの経過時間 (分)', color: '#9146ff' }, grid: { color: '#26262c' }, ticks: { color: '#adadb8' } }
            },
            plugins: {
                legend: { display: false }
            },
            onClick: (event, elements) => {
                if (elements.length > 0 && player) {
                    const index = elements[0].index;
                    const targetMinute = chart.data.labels[index];
                    const targetSeconds = targetMinute * 60;
                    
                    console.log(`Seeking to: ${targetMinute}分 (${targetSeconds}秒)`);
                    player.seek(targetSeconds);
                }
            }
        }
    });

    function updateChart() {
        const bins = {};
        let maxMin = 0;
        
        chatTimestamps.forEach(sec => {
            const min = Math.floor(sec / 60);
            bins[min] = (bins[min] || 0) + 1;
            if (min > maxMin) maxMin = min;
        });

        const labels = [];
        const data = [];
        for (let i = 0; i <= maxMin; i++) {
            labels.push(i);
            data.push(bins[i] || 0);
        }

        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update('none'); // アニメーションなしで高速更新
    }
</script>
</body>
</html>