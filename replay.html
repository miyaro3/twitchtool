<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Reviewer - Replay Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <style>
        body { font-family: sans-serif; background: #0e0e10; color: #efeff1; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #player-container { flex: 2; background: #000; position: relative; border-bottom: 2px solid #9146ff; }
        #player { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #graph-container { flex: 1; background: #18181b; padding: 10px; }
        .info-bar { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px; font-size: 13px; border: 1px solid #9146ff; }
        #status-dot { height: 8px; width: 8px; background-color: #f00; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="player-container">
    <div id="player">
        <div style="text-align:center; color:#666;">
            チャットを記録中...<br>振り返りたい時にチャットで <strong>!replay</strong> と打ってください
        </div>
    </div>
    <div class="info-bar">
        <span id="status-dot"></span>
        <span id="display-text">接続中...</span>
    </div>
</div>

<div id="graph-container">
    <canvas id="chatChart"></canvas>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    const startTime = Date.now();
    let chatTimestamps = [];
    let player = null;
    let chart = null;

    if (!channel) {
        alert("URLに ?channel=ID を追加してください");
    } else {
        ComfyJS.Init(channel);
    }

    // チャット記録
    ComfyJS.onChat = (user, message, flags, self, extra) => {
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        chatTimestamps.push(elapsedSeconds);
        updateChart();
    };

    // コマンド判定 (!replay に変更)
    ComfyJS.onCommand = (user, command, message, flags, extra) => {
        if (command === "replay" && (flags.broadcaster || flags.mod)) {
            fetchLatestVOD();
        }
    };

    async function fetchLatestVOD() {
        document.getElementById('display-text').innerText = "最新アーカイブを取得中...";
        try {
            // limit=1&type=archive で最新の録画済みビデオのみを対象にする
            const response = await fetch(`https://decapi.me/twitch/videos/${channel}?limit=1&type=archive`);
            const text = await response.text();
            
            console.log("API Response:", text); // デバッグ用

            let vodId = "";
            // URL形式 (videos/12345) から抽出
            const urlMatch = text.match(/videos\/(\d+)/); 
            if (urlMatch) {
                vodId = urlMatch[1];
            } else {
                // 数字のみを抽出
                const numMatch = text.match(/\d+/g);
                if (numMatch) {
                    // 誤取得（13など）を防ぐため、一番長い数字、または5桁以上の数字を採用
                    vodId = numMatch.find(n => n.length >= 5) || "";
                }
            }

            if (vodId) {
                loadPlayer(vodId);
                document.getElementById('display-text').innerText = `VOD: ${vodId} を読込完了`;
                document.getElementById('status-dot').style.backgroundColor = "#9146ff";
            } else {
                document.getElementById('display-text').innerText = "有効なVOD IDが見つかりません。少し待ってから再度 !replay してください。";
            }
        } catch (e) {
            document.getElementById('display-text').innerText = "通信エラーが発生しました。";
        }
    }

    function loadPlayer(vodId) {
        document.getElementById('player').innerHTML = "";
        player = new Twitch.Player("player", {
            width: "100%", height: "100%",
            video: vodId,
            parent: [window.location.hostname]
        });
    }

    /* グラフ設定 */
    const ctx = document.getElementById('chatChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Chat Count', data: [], borderColor: '#9146ff', backgroundColor: 'rgba(145, 70, 255, 0.2)', fill: true, tension: 0.3 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, grid: { color: '#26262c' } }, x: { ticks: { color: '#adadb8' }, grid: { color: '#26262c' } } },
            plugins: { legend: { display: false } },
            onClick: (e, el) => {
                if (el.length > 0 && player) {
                    const targetMinute = chart.data.labels[el[0].index];
                    player.seek(targetMinute * 60);
                }
            }
        }
    });

    function updateChart() {
        const bins = {};
        let maxMin = 0;
        chatTimestamps.forEach(s => {
            const m = Math.floor(s / 60);
            bins[m] = (bins[m] || 0) + 1;
            if (m > maxMin) maxMin = m;
        });
        const labels = [], data = [];
        for (let i = 0; i <= maxMin; i++) {
            labels.push(i);
            data.push(bins[i] || 0);
        }
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update('none');
    }
</script>
</body>
</html>