<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Nico-Style Overlay Ultimate Optimized</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: transparent;
        }

        #comment-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .comment {
            position: absolute;
            white-space: nowrap;
            font-weight: bold;
            /* 縁取り設定 */
            text-shadow: 
                2px 2px 2px rgba(0,0,0,0.8),
                -1px -1px 0 #000, 1px -1px 0 #000,
                -1px 1px 0 #000, 1px 1px 0 #000;
            left: 0;
            display: inline-block;
            
            /* チラつき防止用のGPU加速設定 */
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
            transform: translateZ(0);
        }

        /* フォント設定 */
        .mincho { font-family: "MS PMincho", "Hiragino Mincho ProN", serif; }
        .gothic { font-family: "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif; }

        /* サイズ設定 */
        .small { font-size: 24px; line-height: 32px; }
        .medium { font-size: 36px; line-height: 46px; }
        .big { font-size: 48px; line-height: 60px; }
    </style>
</head>
<body>
    <div id="comment-container"></div>

    <script>
        const container = document.getElementById('comment-container');
        const params = new URLSearchParams(window.location.search);
        const channel = params.get('channel');

        const DISPLAY_TIME = 4000; 
        const FIXED_TIME = 3000;   
        const LINE_HEIGHTS = { small: 32, medium: 46, big: 60 };
        
        let activeComments = [];

        const commands = {
            pos: ['naka', 'ue', 'shita'],
            size: ['small', 'medium', 'big'],
            font: ['mincho', 'gothic'],
            colors: {
                white: '#ffffff', red: '#ff0000', pink: '#ff8080', orange: '#ffc000',
                yellow: '#ffff00', green: '#00ff00', cyan: '#00ffff', blue: '#0000ff',
                purple: '#c000ff', black: '#000000',
                white2: '#ccccff', red2: '#cc0033', pink2: '#ff33cc', orange2: '#ff6600',
                yellow2: '#999900', green2: '#00cc66', cyan2: '#00cccc', blue2: '#3399ff',
                purple2: '#6633cc', black2: '#666666'
            }
        };

        ComfyJS.onChat = (user, message, flags, self, extra) => {
            if (message.startsWith('!')) return;

            let words = message.split(/\s+/);
            let config = { pos: 'naka', size: 'medium', font: 'gothic', color: '#ffffff' };
            let textStartIndex = 0;

            for (let i = 0; i < words.length; i++) {
                let w = words[i].toLowerCase();
                if (commands.pos.includes(w)) config.pos = w;
                else if (commands.size.includes(w)) config.size = w;
                else if (commands.font.includes(w)) config.font = w;
                else if (commands.colors[w]) config.color = commands.colors[w];
                else if (w.match(/^#[0-9a-f]{6}$/)) config.color = w;
                else { textStartIndex = i; break; }
            }
            
            const fullBody = words.slice(textStartIndex).join(' ');
            if (!fullBody) return;

            // 改行と「\n」「¥n」文字列の両方に対応
            const lines = fullBody.replace(/\\n|¥n/g, '\n').split(/\n/);
            
            lines.forEach((lineText, index) => {
                const trimmedLine = lineText.trim();
                if (trimmedLine) {
                    setTimeout(() => {
                        createComment(trimmedLine, config);
                    }, index * 120); 
                }
            });
        };

        function createComment(text, config) {
            const el = document.createElement('div');
            el.className = `comment ${config.size} ${config.font}`;
            el.style.color = config.color;
            el.innerText = text;
            
            // 計測中は非表示にしてチラつきを防止
            el.style.opacity = '0';
            el.style.left = '100vw';
            container.appendChild(el);

            requestAnimationFrame(() => {
                const rect = el.getBoundingClientRect();
                const textWidth = Math.ceil(rect.width);
                const screenWidth = window.innerWidth;
                const height = LINE_HEIGHTS[config.size];
                
                el.style.opacity = '1';

                if (config.pos === 'naka') {
                    const top = findNakaY(height, textWidth);
                    el.style.top = top + 'px';
                    
                    const totalDistance = screenWidth + textWidth;
                    const speed = totalDistance / DISPLAY_TIME;
                    const moveX = Math.floor(totalDistance + 100); // 整数化

                    el.style.transition = `transform ${DISPLAY_TIME}ms linear`;
                    el.style.transform = `translateX(-${moveX}px)`;

                    const commentObj = { 
                        el, top, height, width: textWidth, 
                        startTime: Date.now(), type: 'naka', speed 
                    };
                    activeComments.push(commentObj);
                    setTimeout(() => {
                        activeComments = activeComments.filter(c => c !== commentObj);
                        el.remove();
                    }, DISPLAY_TIME);

                } else {
                    el.style.left = '0';
                    el.style.width = '100%';
                    el.style.textAlign = 'center';
                    
                    const top = findFixedY(config.pos, height);
                    el.style.top = top + 'px';
                    
                    const commentObj = { el, top, height, endTime: Date.now() + FIXED_TIME, type: config.pos };
                    activeComments.push(commentObj);
                    setTimeout(() => {
                        activeComments = activeComments.filter(c => c !== commentObj);
                        el.remove();
                    }, FIXED_TIME);
                }
            });
        }

        function findNakaY(h, w) {
            const screenW = window.innerWidth;
            for (let y = 0; y <= window.innerHeight - h; y += 10) {
                let collision = activeComments.some(c => {
                    if (c.type !== 'naka' || Math.abs(c.top - y) >= Math.max(h, c.height)) return false;
                    const timeElapsed = Date.now() - c.startTime;
                    const cCurrentLeft = screenW - (c.speed * timeElapsed);
                    if (cCurrentLeft + c.width > screenW) return true;
                    const myFinishTime = DISPLAY_TIME;
                    const cPosAtMyFinish = screenW - (c.speed * (timeElapsed + myFinishTime));
                    if (cPosAtMyFinish + c.width > -w) return true;
                    return false;
                });
                if (!collision) return y;
            }
            return Math.random() * (window.innerHeight - h);
        }

        function findFixedY(pos, h) {
            const screenH = window.innerHeight;
            let candidateY = (pos === 'ue') ? 0 : screenH - h;
            const step = (pos === 'ue') ? 5 : -5;
            while (candidateY >= 0 && candidateY <= screenH - h) {
                let collision = activeComments.some(c => 
                    c.type === pos && Math.abs(c.top - candidateY) < Math.max(h, c.height)
                );
                if (!collision) return candidateY;
                candidateY += step;
            }
            return (pos === 'ue') ? 0 : screenH - h;
        }

        if (channel) {
            ComfyJS.Init(channel);
        } else {
            container.innerHTML = "<div style='color:white; font-family:sans-serif; text-align:center; padding-top:100px;'><h2>[Config Error]</h2>?channel=ID をURLに付けてください</div>";
        }
    </script>
</body>
</html>